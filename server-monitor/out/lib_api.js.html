<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>JSDoc: Source: lib/api.js</title>

        <script src="scripts/prettify/prettify.js"></script>
        <script src="scripts/prettify/lang-css.js"></script>
        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link
            type="text/css"
            rel="stylesheet"
            href="styles/prettify-tomorrow.css"
        />
        <link
            type="text/css"
            rel="stylesheet"
            href="styles/jsdoc-default.css"
        />
    </head>

    <body>
        <div id="main">
            <h1 class="page-title">Source: lib/api.js</h1>

            <section>
                <article>
                    <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Main API to authenticate user, start and stop server monitoring.
 * @author HackerBay, Inc.
 * @module api
 * @see module:helpers
 * @see module:logger
 */

'use strict';

const dotenv = require('dotenv');
const Promise = require('promise');
const cron = require('cron');
const si = require('systeminformation');
const { get, post } = require('./helpers');
const logger = require('./logger');

dotenv.config();

/**
 * Get system information at interval and upload to server.
 * @param {string} projectId - The project id of the project.
 * @param {string} monitorId - The monitor id of the server monitor.
 * @param {string} apiKey - The api key of the project.
 * @param {string} interval - The interval of the cron job, must ba a valid cron format.
 * @return {Object} The ping server cron job.
 */
const ping = (projectId, monitorId, apiKey, interval = '* * * * *') => {
  return new cron.CronJob(interval, () => {
    Promise.all([
      si.currentLoad(),
      si.mem(),
      si.fsSize(),
      si.networkStats(),
      si.cpuTemperature(),
      si.cpu(),
      si.users(),
      si.networkConnections(),
      si.vboxInfo()
    ])
      .then(data => ({
        load: data[0],
        memory: data[1],
        disk: data[2],
        traffic: data[3],
        temperature: data[4],
        resources: data[5],
        users: data[6],
        network: data[7],
        vbox: data[8]
      }))
      .then(data => {
        post(`monitor/${projectId}/log/${monitorId}`, { data }, apiKey, () => {
          logger.info(`${monitorId} - System Information uploaded`);
        });
      })
      .catch(error => { logger.debug(error) });
  }, null, false);
};

/**
 * Authenticate user and get list of server monitors if monitor id not provided.
 * @param {(string | Object)} config - The project id or config of the project.
 * @param {string} apiKey - The api key of the project.
 * @param {(string | Function)} monitorId - The monitor id or function to resolve monitor id of the server monitor.
 * @return {Object} The server monitor handlers.
 */
module.exports = (config, apiKey, monitorId) => {
  let pingServer, projectId = config;

  if (typeof config === 'object') {
    projectId = config.projectId;
    apiKey = config.apiKey;
    monitorId = config.monitorId;
  }

  return {
    /**
     * Start server monitor.
     * @param {string} id - The monitor id of the server monitor.
     * @return {(Object | number)} The ping server cron job or the error code.
     */
    start: (id = monitorId) => {
      let url = `monitor/${projectId}/monitor/${id &amp;&amp; typeof id === 'string' ? `${id}/` : ''}?type=server-monitor`;

      return get(url, apiKey, response => {
        return new Promise((resolve, reject) => {
          const data = response.data;

          if (data !== null) {
            if (id &amp;&amp; typeof id === 'string') {
              resolve(data._id);
            } else {
              if (data.data !== null &amp;&amp; data.data.length > 0) {
                if (data.count === 1) {
                  logger.info('Using default Server Monitor...');
                  resolve(data.data[0]._id);
                } else {
                  if (id &amp;&amp; typeof id === 'function') {
                    resolve(id(data.data));
                  } else {
                    logger.info('Server Monitor ID is required');
                    reject(1)
                  }
                }
              } else {
                logger.info('No Server Monitor found');
                reject(0)
              }
            }
          } else {
            logger.info('No Server Monitor found');
            reject(0)
          }
        });
      }).then(monitorId => {
        if (monitorId) {
          logger.info('Starting Server Monitor...');
          pingServer = ping(projectId, monitorId, apiKey, config.interval);
          pingServer.start();

          if (config.timeout) {
            setTimeout(() => {
              logger.info('Stopping Server Monitor...');
              pingServer.stop()
            }, config.timeout);
          }

          return pingServer;
        } else {
          logger.info('Server Monitor ID is required');
          throw new Error(1);
        }
      }).catch(error => {
        const errorCode = typeof error === 'number' ? error : 1;
        process.exitCode = errorCode;

        return errorCode;
      });
    },
    /** Stop server monitor. 
     * @return {Object} The ping server cron job.
     */
    stop: () => {
      if (pingServer) {
        logger.info('Stopping Server Monitor...');
        pingServer.stop();
      }

      return pingServer;
    }
  }
};
</code></pre>
                </article>
            </section>
        </div>

        <nav>
            <h2><a href="index.html">Home</a></h2>
            <h3>Modules</h3>
            <ul>
                <li><a href="module-api.html">api</a></li>
                <li><a href="module-config.html">config</a></li>
                <li><a href="module-helpers.html">helpers</a></li>
                <li><a href="module-logger.html">logger</a></li>
                <li><a href="module-server-monitor.html">server-monitor</a></li>
            </ul>
        </nav>

        <br class="clear" />

        <footer>
            Documentation generated by
            <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Nov
            03 2019 13:03:34 GMT+0100 (West Africa Standard Time)
        </footer>

        <script>
            prettyPrint();
        </script>
        <script src="scripts/linenumber.js"></script>
    </body>
</html>
